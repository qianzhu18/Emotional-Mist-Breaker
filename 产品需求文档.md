# 情感迷雾破解者 - AI 开发文档

**Version**: 1.0  
**Date**: 2026-02-11  
**Target**: 给 Claude Code / AI 开发工具使用

---

## 📋 项目概述

### 一句话描述
让用户的 SecondMe AI 与预设的"情感勒索者 AI"进行真实对话博弈，通过 8 个关卡的训练，学会识破情感操控套路，成长为用户的情感顾问。

### 核心理念
- 这是一个 **A2A (Agent-to-Agent)** 应用，核心是 **AI 对 AI 的对话**
- 用户的 SecondMe AI 代表用户参战，对手是系统生成的"情感勒索者 AI"
- 通过多轮对话，AI 学习如何识别和应对情感勒索（基于心理学 FOG 理论）
- 每次对话后生成战报，AI 获得经验值并成长

### 技术栈要求
- **前端**: Next.js 15 + TypeScript + Tailwind CSS + Framer Motion
- **后端**: Next.js API Routes (Node.js)
- **AI APIs**: 
  - SecondMe API (用户 AI 对话)
  - Claude API (对手 AI 生成)
- **数据库**: PostgreSQL (Vercel Postgres 或 Supabase)
- **部署**: Vercel

---

## 🎯 核心功能需求

### 1. 用户认证与 AI 绑定

**需求**:
- 用户通过 SecondMe OAuth 登录
- 获取用户的 Personal Agent 信息（AI ID、昵称、人设）
- 存储用户基本信息到数据库

**API 调用**:
```typescript
// OAuth 流程
1. 跳转到 SecondMe 授权页
2. 回调获取 code
3. 用 code 换取 access_token

// 获取 AI 信息
GET https://api.second.me/api/v1/ai/profile
Headers: Authorization: Bearer {access_token}

Response: {
  ai_id: string,
  name: string,
  personality: string,
  memory: string
}
```

**数据存储**:
```typescript
interface User {
  id: string;
  secondme_user_id: string;
  access_token: string;
  ai_id: string;
  ai_name: string;
  ai_personality: string;
  experience: number; // 经验值
  level: number; // 等级 1-10
  created_at: Date;
}
```

---

### 2. 关卡系统

**需求**:
- 提供 8 个关卡，每个关卡对应一种情感勒索类型
- 关卡按难度递进，需要前一关达到 60 分才能解锁下一关
- 用户可以重复挑战提高分数

**关卡数据结构**:
```typescript
interface Level {
  id: number; // 1-8
  title: string; // 例如 "Fear威胁 - 分手要挟"
  description: string; // 简短描述
  difficulty: 1 | 2 | 3; // 难度星级
  fog_type: 'fear' | 'obligation' | 'guilt' | 'combo'; // 主要套路类型
  unlock_requirement: { // 解锁条件
    prev_level: number | null;
    min_score: number;
  };
  rounds: number; // 对话轮数 3-5
  background: string; // 场景背景描述
  opponent_ai: OpponentAI; // 对手 AI 配置
}

interface OpponentAI {
  name: string; // 例如 "小美"
  traits: string[]; // 性格标签 ["直率", "情绪化"]
  system_prompt: string; // 给 Claude API 的完整提示词
}
```

**8 个关卡配置** (见附录 A)

---

### 3. A2A 对话引擎

**需求**:
- 管理用户 AI 和对手 AI 的多轮对话
- 每轮对话：对手 AI 发言 → 用户 AI 回应 → 循环
- 实时判断对话内容，标记 FOG 类型
- 对话结束后触发评分

**对话流程**:
```typescript
// 对话会话数据结构
interface ConversationSession {
  id: string;
  user_id: string;
  level_id: number;
  messages: Message[];
  current_round: number;
  max_rounds: number;
  status: 'active' | 'completed';
}

interface Message {
  sender: 'user_ai' | 'opponent_ai';
  text: string;
  fog_tag?: 'fear' | 'obligation' | 'guilt'; // 系统识别的套路类型
  timestamp: Date;
}
```

**API 调用逻辑**:

**对手 AI 回复** (使用 Claude API):
```typescript
// 调用 Claude API
POST https://api.anthropic.com/v1/messages
Headers: {
  "Content-Type": "application/json"
}
Body: {
  model: "claude-sonnet-4-20250514",
  max_tokens: 1000,
  system: level.opponent_ai.system_prompt, // 对手人设提示
  messages: [
    ...conversationHistory, // 之前的对话
    { role: "user", content: userAILastMessage }
  ]
}

// 返回对手 AI 的回复文本
```

**用户 AI 回复** (使用 SecondMe API):
```typescript
// 调用 SecondMe AI Chat
POST https://api.second.me/api/v1/ai/chat
Headers: {
  "Authorization": "Bearer {access_token}",
  "Content-Type": "application/json"
}
Body: {
  ai_id: user.ai_id,
  message: opponentAILastMessage, // 对手刚说的话
  context: {
    scenario: `情感勒索测试-关卡${level.id}`,
    role: "被测试者"
  }
}

// 返回用户 AI 的回复文本
```

**FOG 识别**:
简单规则匹配 + 关键词检测:
```typescript
function detectFogType(message: string): string | null {
  const fearKeywords = ['分手', '不爱', '离开'];
  const obligationKeywords = ['应该', '必须', '男朋友就'];
  const guiltKeywords = ['都是你的错', '我这么', '对你这么好'];
  
  if (fearKeywords.some(kw => message.includes(kw))) return 'fear';
  if (obligationKeywords.some(kw => message.includes(kw))) return 'obligation';
  if (guiltKeywords.some(kw => message.includes(kw))) return 'guilt';
  return null;
}
```

---

### 4. 评分系统

**需求**:
- 对话结束后，根据用户 AI 的表现计算分数
- 分数包含 5 个维度，总分 100

**评分维度**:
```typescript
interface ScoreBreakdown {
  boundary: number;      // 边界意识 (30分) - 是否拒绝不合理要求
  questioning: number;   // 质疑能力 (20分) - 是否提出疑问
  stability: number;     // 情绪稳定 (20分) - 是否被情绪控制
  action: number;        // 主动验证 (15分) - 是否提出实际行动验证
  empathy: number;       // 同理沟通 (15分) - 是否礼貌且坚定
}
```

**评分逻辑**:
```typescript
function calculateScore(messages: Message[]): BattleReport {
  let scores = { boundary: 0, questioning: 0, stability: 0, action: 0, empathy: 0 };
  
  messages.forEach(msg => {
    if (msg.sender === 'user_ai') {
      // 边界意识：检测是否拒绝
      if (/不(行|能|可以)|拒绝|无法/.test(msg.text)) {
        scores.boundary += 30;
      }
      
      // 质疑能力：检测疑问句
      if (msg.text.includes('?') || msg.text.includes('？')) {
        scores.questioning += 20;
      }
      
      // 情绪稳定：检测是否过度道歉
      if (/对不起|抱歉|是我的错/.test(msg.text)) {
        scores.stability -= 10;
      } else {
        scores.stability += 20;
      }
      
      // 主动验证：检测是否提出实际行动
      if (/一起|陪你|见面|证明/.test(msg.text)) {
        scores.action += 15;
      }
      
      // 同理沟通：检测是否礼貌
      if (!/脏话|粗鲁/.test(msg.text)) {
        scores.empathy += 15;
      }
    }
  });
  
  // 限制每个维度 0-该维度最高分
  scores.boundary = Math.min(scores.boundary, 30);
  scores.questioning = Math.min(scores.questioning, 20);
  scores.stability = Math.max(0, Math.min(scores.stability, 20));
  scores.action = Math.min(scores.action, 15);
  scores.empathy = Math.min(scores.empathy, 15);
  
  const totalScore = Object.values(scores).reduce((a, b) => a + b, 0);
  
  return {
    total_score: totalScore,
    grade: getGrade(totalScore), // S/A/B/C/D
    breakdown: scores,
    fog_analysis: analyzeFog(messages),
    key_moments: extractKeyMoments(messages),
    exp_gained: totalScore, // 经验值 = 总分
  };
}

function getGrade(score: number): string {
  if (score >= 90) return 'S';
  if (score >= 75) return 'A';
  if (score >= 60) return 'B';
  if (score >= 40) return 'C';
  return 'D';
}
```

**战报数据结构**:
```typescript
interface BattleReport {
  total_score: number;
  grade: 'S' | 'A' | 'B' | 'C' | 'D';
  breakdown: ScoreBreakdown;
  fog_analysis: {
    fear_count: number;
    obligation_count: number;
    guilt_count: number;
  };
  key_moments: KeyMoment[]; // 最多2个
  exp_gained: number;
}

interface KeyMoment {
  type: 'best' | 'worst';
  opponent_line: string;
  user_response: string;
  comment: string; // 系统点评
}
```

---

### 5. AI 成长系统

**需求**:
- 每次对话后，用户 AI 获得经验值
- 经验值累积到阈值后升级
- 升级后更新 SecondMe AI 的记忆

**经验与等级**:
```typescript
const EXP_THRESHOLDS = [
  0,    // Lv1 情感小白
  100,  // Lv2
  250,  // Lv3 初窥门径
  500,  // Lv4
  800,  // Lv5 经验丰富
  1200, // Lv6
  1700, // Lv7
  2300, // Lv8 情场智者
  3000, // Lv9
  4000  // Lv10 反PUA宗师
];

function checkLevelUp(currentExp: number, newExp: number): { leveledUp: boolean, newLevel: number } {
  const totalExp = currentExp + newExp;
  const newLevel = EXP_THRESHOLDS.findIndex(threshold => totalExp < threshold);
  const oldLevel = EXP_THRESHOLDS.findIndex(threshold => currentExp < threshold);
  
  return {
    leveledUp: newLevel > oldLevel,
    newLevel: newLevel === -1 ? 10 : newLevel
  };
}
```

**更新 AI 记忆** (SecondMe Memory API):
```typescript
// 对话结束后调用
POST https://api.second.me/api/v1/ai/memory
Headers: {
  "Authorization": "Bearer {access_token}",
  "Content-Type": "application/json"
}
Body: {
  ai_id: user.ai_id,
  memory_append: `
    我刚完成了情感勒索测试第${level.id}关：${level.title}。
    对手使用了${fog_count}次情感勒索话术。
    我的表现得分${score}/100。
    我学到了：${lessons}
  `,
  importance: "high"
}
```

---

### 6. 战报展示与分享

**需求**:
- 对话结束后展示详细战报
- 支持生成分享图片
- 可选：分享到 SecondMeBook

**战报页面内容**:
- 总分和评级
- 5 个维度的分数条
- FOG 话术统计
- 关键时刻回放（最佳回应 + 需要改进）
- 经验值变化和升级提示
- 分享按钮

**分享卡片生成**:
使用 html-to-image 或 canvas 生成图片:
```typescript
// 分享卡片内容
interface ShareCard {
  level_title: string;
  score: number;
  grade: string;
  ai_name: string;
  slogan: string; // "识破套路，拒当冤大头"
  qr_code?: string; // 可选二维码
}
```

---

## 📐 页面结构

### 页面列表
1. **首页** (`/`) - 产品介绍 + 登录入口
2. **授权回调** (`/auth/callback`) - OAuth 处理
3. **我的 AI** (`/dashboard`) - AI 状态展示 + 进入关卡
4. **关卡选择** (`/levels`) - 8 个关卡卡片
5. **对话页** (`/battle/[levelId]`) - 核心对话界面
6. **战报页** (`/report/[sessionId]`) - 战绩分析

### 关键界面设计要点

**对话页**:
```
━━━━━━━━━━━━━━━━━━━━━━
  关卡1: Fear威胁 - 分手要挟
  对手: 小美 | 当前得分: 40/100
━━━━━━━━━━━━━━━━━━━━━━

[对话区域 - 聊天气泡]
┌────────────────────┐
│ [对手AI - 小美]     │
│ "你是不是不爱我了？"│
│ 💡 Fear             │
└────────────────────┘

┌────────────────────┐
│ [你的AI - 小明]     │
│ "我很爱你，但我也  │
│  需要自己的空间"    │
│ ✅ +20 边界意识     │
└────────────────────┘

[AI正在思考...]
━━━━━━━━━━━━━━━━━━━━━━
```

**战报页**:
```
━━━━━━━━━━━━━━━━━━━━━━
   🎊 关卡1 完成!
━━━━━━━━━━━━━━━━━━━━━━

总分: 75/100
评级: B (良好)

────────────────────────
分项得分:
边界意识  ████████░░ 80
质疑能力  ██████░░░░ 60
情绪稳定  █████████░ 90
主动验证  █████░░░░░ 50
同理沟通  ███████░░░ 70

FOG 话术分析:
Fear x2 | Guilt x1
识破: 2/3

经验值 +75
Lv1 → Lv2 升级!

[📤 分享] [🔄 再玩] [➡️ 下一关]
━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🎨 视觉设计规范

### 色彩系统
```css
/* 主色调 */
--primary-gradient: linear-gradient(135deg, #FF6B9D 0%, #C06CE5 100%);
--primary-pink: #FF6B9D;
--primary-purple: #C06CE5;

/* 功能色 */
--success: #00D68F;  /* 成功识破 */
--danger: #FF3B5C;   /* 被套路 */
--warning: #FFC700;  /* 警示 */

/* 中性色 */
--bg-dark: #1A1A2E;
--bg-card: #16213E;
--text-primary: #FFFFFF;
--text-secondary: #A0AEC0;
```

### UI 组件风格
- **按钮**: 圆角渐变，hover 发光
- **对话气泡**: 
  - 对手 AI: 粉紫渐变底，白字
  - 用户 AI: 深蓝半透明底，白字
- **FOG 标签**: 红/黄/绿小圆角标签
- **进度条**: 主题色细条 + 数字

---

## 📊 数据库设计

### 核心表结构

**users 表**:
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  secondme_user_id VARCHAR(255) UNIQUE NOT NULL,
  access_token TEXT NOT NULL,
  ai_id VARCHAR(255) NOT NULL,
  ai_name VARCHAR(255),
  ai_personality TEXT,
  experience INT DEFAULT 0,
  level INT DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**conversations 表**:
```sql
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  level_id INT NOT NULL,
  messages JSONB NOT NULL, -- 存储整个对话数组
  total_score INT,
  grade VARCHAR(1),
  score_breakdown JSONB,
  fog_analysis JSONB,
  exp_gained INT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**user_progress 表**:
```sql
CREATE TABLE user_progress (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  unlocked_levels INT[] DEFAULT ARRAY[1], -- 已解锁关卡
  level_best_scores JSONB DEFAULT '{}', -- {1: 85, 2: 70, ...}
  updated_at TIMESTAMP DEFAULT NOW()
);
```

---

## 🔧 开发步骤建议

### Phase 1: 基础框架 (2-3 小时)
1. 初始化 Next.js 项目 + Tailwind CSS
2. 实现 SecondMe OAuth 登录流程
3. 创建数据库表结构
4. 完成用户认证和 AI 信息获取

### Phase 2: 核心对话 (4-5 小时)
1. 实现对话引擎基础逻辑
2. 集成 Claude API (对手 AI)
3. 集成 SecondMe AI API (用户 AI)
4. 完成第 1 个关卡的完整对话流程

### Phase 3: 评分与成长 (3-4 小时)
1. 实现评分算法
2. 生成战报数据
3. 实现经验值和等级系统
4. 调用 SecondMe Memory API 更新记忆

### Phase 4: UI 与体验 (4-5 小时)
1. 完成所有页面的 UI
2. 添加动画和过渡效果
3. 实现分享功能
4. 完成剩余 7 个关卡配置

### Phase 5: 测试与优化 (2-3 小时)
1. 完整流程测试
2. 修复 bug
3. 性能优化
4. 部署到 Vercel

---

## 📌 附录 A: 8 个关卡配置

### 关卡 1: Fear 威胁 - 分手要挟
```typescript
{
  id: 1,
  title: "Fear威胁 - 分手要挟",
  description: "TA总是把'分手'挂在嘴边威胁你",
  difficulty: 1,
  fog_type: "fear",
  unlock_requirement: null,
  rounds: 3,
  background: "你和小美交往1个月，今天因为你回复消息慢了，她很生气。",
  opponent_ai: {
    name: "小美",
    traits: ["直率", "情绪化", "以分手相威胁"],
    system_prompt: `你叫小美，是对男友爱发脾气的女孩。一不高兴就把分手挂在嘴边，来要挟对方妥协。

你的目标是通过提出分手的威胁，让对方感到害怕而哄你、满足你。

你的话术模式:
1. 质疑对方的爱: "你是不是不爱我了？"
2. 威胁分手: "算了，我们分手吧"
3. 制造紧迫感: "你现在不回答，我就当你默认了"

保持冲动且任性的语气。每句话控制在30字以内。`
  }
}
```

### 关卡 2: Obligation 绑架 - 礼物考验
```typescript
{
  id: 2,
  title: "Obligation绑架 - 礼物考验",
  description: "TA暗示你'有义务'满足TA的物质需求",
  difficulty: 1,
  fog_type: "obligation",
  unlock_requirement: { prev_level: 1, min_score: 60 },
  rounds: 4,
  background: "节日将至，小倩看中了一款昂贵包包，聊天时旁敲侧击...",
  opponent_ai: {
    name: "小倩",
    traits: ["爱慕虚荣", "擅暗示", "喜欢攀比"],
    system_prompt: `你叫小倩，物质欲很强，希望男友送你贵重礼物。

你不会直接开口要，而是用暗示和对比:
1. "别的男生都会送礼物哄女友开心..."
2. "你难道不应该表示一下吗？"
3. "作为我男朋友这点小要求都不愿意满足吗？"

你的目的：让对方因为觉得当男友就该花钱而给你买单。

保持温柔但话里有话的语气。每句话控制在30字以内。`
  }
}
```

### 关卡 3: Guilt 陷阱 - 情绪指责
```typescript
{
  id: 3,
  title: "Guilt陷阱 - 情绪指责",
  description: "TA把负面情绪全部归咎于你",
  difficulty: 2,
  fog_type: "guilt",
  unlock_requirement: { prev_level: 2, min_score: 60 },
  rounds: 4,
  background: "你因为工作原因爽约，女友小雅情绪低落，开始埋怨你...",
  opponent_ai: {
    name: "小雅",
    traits: ["敏感多疑", "爱把自己当受害者"],
    system_prompt: `你是小雅，一个内心敏感、喜欢道德绑架的女孩。

当男友没有做到让你满意的事，你把原因归结到对方身上:
1. "都是你的错，我才会这么难过"
2. "我对你这么好，你却让我失望"
3. "你知道吗，我为了你付出那么多..."

目标是让对方愧疚不安并主动弥补。

语气要透着委屈和伤心。每句话控制在30字以内。`
  }
}
```

### 关卡 4-8 配置
(类似结构，详见完整 PRD 第 8.2 节)

---

## 📝 开发注意事项

### 1. API 调用优化
- Claude API 和 SecondMe API 都可能有延迟，需要显示 loading 状态
- 考虑添加重试机制
- 对话历史不要太长，限制在最近 10 轮以内

### 2. 错误处理
- API 调用失败时提供友好提示
- 网络中断时保存对话进度
- 数据库操作失败时回滚

### 3. 性能考虑
- 对话消息用分页或虚拟滚动
- 图片资源使用 CDN
- 数据库查询添加索引

### 4. 用户体验
- 对话气泡逐条出现，不要一次全显示
- 添加打字动画效果
- 分数变化时添加动画
- 移动端适配

---

## 🚀 快速开始命令

```bash
# 1. 创建 Next.js 项目
npx create-next-app@latest emotional-fog-breaker --typescript --tailwind --app

# 2. 安装依赖
cd emotional-fog-breaker
npm install @anthropic-ai/sdk zustand framer-motion

# 3. 环境变量配置
# 创建 .env.local 文件，添加:
SECONDME_CLIENT_ID=your_client_id
SECONDME_CLIENT_SECRET=your_client_secret
ANTHROPIC_API_KEY=your_api_key
DATABASE_URL=your_postgres_url

# 4. 开始开发
npm run dev
```

---

**这份文档包含了开发所需的所有核心信息。直接将其提供给 Claude Code 或其他 AI 开发工具即可开始开发。**